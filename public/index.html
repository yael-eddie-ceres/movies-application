<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />

    <!-- google fonts -->
    <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <title>My Application</title>
    <link rel="stylesheet" href="/style.css" />
</head>
<body>
    <!-- Loading spinner -->
    <div class="loading" id="loading">
        <img src="./img/loading.gif" alt="">
    </div>

    <!-- page content -->
    <div class="wrapper">


         <div class="container" id="container">

            <!-- form -->
            <div class="form">
                <input type="text" maxlength="19" name="title" placeholder="Title" id="title">
                <input type="number"  min="0" max="5" name="rating" placeholder="rating" id="rating">
                <input type="button" name="submit" onclick="addMovie()" value="submit your movie!">
            </div>

            <!-- cards -->
            <div class="cards bborder" id="cards">

                <!-- <div class="card-row">
                    <div class="card">
                        <h3 class="card-title">Tomorrow Never Dies</h3>
                        <h2 class="card-rating">5</h2>
                        <div class="card-btns">
                            <i onclick="editMovie()" class="fas fa-edit"></i>
                            <i onclick="removeMovie()" class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>
                    <div class="card">
                        <h3 class="card-title">Tomorrow Never Dies</h3>
                        <h2 class="card-rating">5</h2>
                        <div class="card-btns">
                            <i onclick="editMovie()" class="fas fa-edit"></i>
                            <i onclick="removeMovie()" class="fas fa-times-circle"></i>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Tomorrow Never Dies</h3>
                        <h2 class="card-rating">5</h2>
                        <div class="card-btns">
                            <i onclick="editMovie()" class="fas fa-edit"></i>
                            <i onclick="removeMovie()" class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>

                <div class="card-row">
                    <div class="card">
                        <h3 class="card-title">Tomorrow Never Dies</h3>
                        <h2 class="card-rating">5</h2>
                        <div class="card-btns">
                            <i onclick="editMovie()" class="fas fa-edit"></i>
                            <i onclick="removeMovie()" class="fas fa-times-circle"></i>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Tomorrow Never Dies</h3>
                        <h2 class="card-rating">5</h2>
                        <div class="card-btns">
                            <i onclick="editMovie()" class="fas fa-edit"></i>
                            <i onclick="removeMovie()" class="fas fa-times-circle"></i>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Tomorrow Never Dies</h3>
                        <h2 class="card-rating">5</h2>
                        <div class="card-btns">
                            <i onclick="editMovie()" class="fas fa-edit"></i>
                            <i onclick="removeMovie()" class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div> -->



            </div>


            <!-- test print data -->
            <div id="test"></div>
<!--        <img src="./img/pug.gif" class="pug" alt="pug">-->
        </div>
        <!-- random pug picture -->
    </div>


    <script src="./main.js"></script>
    <script>
        const title = document.getElementById("title");
        const rating = document.getElementById("rating");

        let movieData = "";

        // Updates movie list on page
        const updateMovies = () => {
            fetch('api/movies')
                .then(response => response.json())
                .then(response => {
                    // test.innerHTML = "";
                    console.log(response);
                    let moviesCounter = 0;
                    response.forEach(({title, rating, id}) => {
                        console.log(`id#${id} - ${title} - rating: ${rating}`);
                        movieData += `<p>id#${id} - ${title} - rating: ${rating} - <a onClick="removeMovie(${id})">DELETE</a></p>`;

                        // Increment counter
                        moviesCounter++;

                        console.log(moviesCounter);

                        // Add data to cards

                        if (moviesCounter === 1) {
                            cardData += `<div class="card-row">`
                            cardData += `<div class="card">`
                            cardData += `<h3 class="card-title">${title}</h3>`
                            cardData += `<h2 class="card-rating">${rating}</h2>`
                            cardData += `<div class="card-btns">`
                            cardData += `<i onclick="editMovie(${id})" class="fas fa-edit"></i>`
                            cardData += `<i onclick="removeMovie(${id})" class="fas fa-times-circle"></i>`
                            cardData += `</div>`
                            cardData += `</div>`
                        } else if (moviesCounter === 3) {
                            cardData += `<div class="card">`
                            cardData += `<h3 class="card-title">${title}</h3>`
                            cardData += `<h2 class="card-rating">${rating}</h2>`
                            cardData += `<div class="card-btns">`
                            cardData += `<i onclick="editMovie(${id})" class="fas fa-edit"></i>`
                            cardData += `<i onclick="removeMovie(${id})" class="fas fa-times-circle"></i>`
                            cardData += `</div>`
                            cardData += `</div>`
                            cardData += `</div>`
                            moviesCounter = 0;
                        } else {
                            cardData += `<div class="card">`
                            cardData += `<h3 class="card-title">${title}</h3>`
                            cardData += `<h2 class="card-rating">${rating}</h2>`
                            cardData += `<div class="card-btns">`
                            cardData += `<i onclick="editMovie(${id})" class="fas fa-edit"></i>`
                            cardData += `<i onclick="removeMovie(${id})" class="fas fa-times-circle"></i>`
                            cardData += `</div>`
                            cardData += `</div>`
                        }
                    });
                })
                .then(() => {
                    // test.innerHTML = movieData;
                    cards.innerHTML = cardData;
                });
            };


        // Add movie to db
        const addMovie = (name, ratingScore) => {

            // If there are empty arguments, get the values from the form.
            if (name === undefined || ratingScore === undefined) {
                var data = JSON.stringify({
                    "title": title.value,
                    "rating": rating.value
                });
            } else {
                var data = JSON.stringify({
                    "title": name,
                    "rating": rating
                });
            }


            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                console.log(this.responseText);
                }
            });

            xhr.open("POST", "http://localhost:3000/movies");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("Accept", "*/*");
            xhr.setRequestHeader("Cache-Control", "no-cache");
            xhr.setRequestHeader("Postman-Token", "b1af016e-fc8a-4475-ada2-f774f4d6d1b4,30cc452f-72c0-4642-9c3e-1bfffdaae4bc");
            xhr.setRequestHeader("cache-control", "no-cache");

            xhr.send(data);

            // Clear page of all data before we get new data
            // test.innerHTML = "";
            cards.innerHTML = "";
            movieData = "";
            cardData = "";

            // Need a way to refresh the page after click
            setTimeout(updateMovies, 200);
        }



        const editMovie = () => {
            console.log("You want to edit movie?");
        };




        // remove movie from db
        const removeMovie = (id) => {
            var data = null;

            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;

            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                console.log(this.responseText);
                }
            });

            xhr.open("DELETE", `http://localhost:3000/movies/${id}`);
            xhr.setRequestHeader("Accept", "*/*");
            xhr.setRequestHeader("Cache-Control", "no-cache");
            xhr.setRequestHeader("Postman-Token", "61abf9cb-a691-46c2-ab19-eeb996079ae9,162c3d48-e112-450b-aaa4-9c9cbaf5687f");
            xhr.setRequestHeader("cache-control", "no-cache");

            xhr.send(data);

            // Clear page of all data before we get new data
            test.innerHTML = "";
            cards.innerHTML = "";
            movieData = "";
            cardData = "";

            // Need a way to refresh the page after click
            setTimeout(updateMovies, 800);
        }

    </script>
</body>
</html>
